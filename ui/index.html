<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMSee</title>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/2.8.2/alpine.js" integrity="sha512-No22QdEJ4zlXvdQDpm6oeXcjwajpNxvnstx6NEU/5qZFysa5gsgj/bSfAFpSc9Za5LjbgQLRXyCeY53aWmk8ZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100%;
            width: 100%;
            padding: 0 15px;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            height: 90%;
            max-width: 90%;
            max-height: 90%;
            border-radius: 5px;
            overflow-y: auto;
        }

        .modal-content pre,
        .modal-content pre code {
            max-height: 300px;
            white-space: pre-wrap !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 100% !important;
        }

        .modal-content code {
            font-size: .8em !important;
            border: none !important;
        }

        .modal-content code[class*=language-] {
            padding: 0;
        }

        .modal-content div {
            position: relative;
        }

        .modal-content button.copy-btn {
            position: absolute;
            top: -35px;
            right: 0px;
            width: 30px;
            height: 30px;
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #ffffff;
        }

        .modal-content button.copy-btn:hover {
            border-color: #33C3F0;
            background-color: #33C3F0;
        }

        .modal-content .log-container {
            display: block;
        }

        .modal-content .log-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1px;
        }

        /* For small screens, the sections stack vertically */
        @media (max-width: 768px) {
            .modal-content .log-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .modal-content .log-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        span.status {
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }

        span.status-2xx {
            background-color: #28a745;
        }

        span.status-4xx {
            background-color: #fd7e14;
        }

        span.status-5xx {
            background-color: #dc3545;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        #table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            margin-top: 5px;
        }

        #table-container table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
        }

        /* Ensure the header stays on top */
        #table-container thead th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 30;
            background-color: #33C3F0;
            color: white;
        }

        #table-container th,
        #table-container td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        #table-container th {
            background: #f8f8f8;
            text-align: left;
        }

        #table-container tr.rec {
            cursor: pointer;
            line-height: 0.75;
        }

        #table-container tr.rec:hover {
            background-color: #f0f0f0;
        }

        #table-container tr.rec td {
            font-size: .8em;
            white-space: nowrap;
        }

        #table-container tr.rec td.useragent-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            direction: ltr;
            text-align: left;
        }

        @keyframes fadeOut {
            from {
                background-color: yellow;
            }

            to {
                background-color: white;
            }
        }

        #table-container tr.rec.flash td {
            animation-name: fadeOut;
            animation-duration: 2s;
        }

        #table-container tr.marker {
            cursor: default;
        }

        #table-container tr.marker td {
            border-bottom: 2px solid red;
            padding: 0px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 5px;

        }

        .pagination input {
            margin-bottom: 1rem;
            width: 80px;
            text-align: center;
        }

        .pagination button {
            padding-left: 15px;
            padding-right: 15px;
        }

        .pagination button:disabled,
        .pagination button:disabled:hover {
            cursor: default;
            background-color: #c0c0c0;
            border-color: #c0c0c0;
        }

        #table-container th.center,
        .center {
            text-align: center
        }

        #table-container th.right,
        .right {
            text-align: right
        }
    </style>
</head>

<body>
    <div x-data="logData()" x-init="init()" class="container">
        <!-- Logs Table -->
        <template x-if="!loading">
            <section>
                <div id="table-container">
                    <table class="u-full-width">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>User Agent</th>
                                <th>Provider</th>
                                <th>Model</th>
                                <th class="center">Status</th>
                                <th class="right">Sent</th>
                                <th class="right">Recv</th>
                                <th class="right">Duration</th>
                                <th>Method</td>
                            </tr>
                        </thead>
                        <template x-for="(log, index) in logs" :key="log.id">
                            <tbody>
                                <template x-if="log._marker">
                                    <tr class="marker">
                                        <td colspan="10"></td>
                                    </tr>
                                </template>
                                <template x-if="!log._marker">
                                    <tr @click="fetchLogDetail(log.id)" :class="log._flash ? 'rec flash' : 'rec'">
                                        <td x-text="log.id"></td>
                                        <td x-text="formatTimestamp(log.timestamp)" :title="log.timestamp"></td>
                                        <td x-text="log.useragent" class="useragent-cell" :title="log.useragent"></td>
                                        <td x-text="log.provider"></td>
                                        <td x-text="log.model"></td>
                                        <td class="center"><span x-text="log.response_status" class="status" :class="'status-'+String(log.response_status)[0]+'xx'"></span></td>
                                        <td class="right" x-text="log.request_body_size ? (log.request_body_size/1024).toFixed(2)+' KB' : '-'"></td>
                                        <td class="right" x-text="log.response_body_size ? (log.response_body_size/1024).toFixed(2)+ ' KB' : '-'"></td>
                                        <td class="right" x-text="log.duration_ms >= 0 ? log.duration_ms+ ' ms' : '...'"></td>
                                        <td x-text="log.method"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </template>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button @click="fetchLogs(1)" :disabled="currentPage === 1" class="button button-primary">|&lt;</button>
                    <button @click="fetchLogs(Math.max(currentPage - 1, 1))" :disabled="currentPage === 1" class="button button-primary">&lt;</button>
                    <input type="number" @change="fetchLogs(parseInt($event.target.value))" :value="currentPage">
                    <button @click="fetchLogs(Math.min(currentPage + 1, totalPages))" :disabled="currentPage === totalPages" class="button button-primary">&gt;</button>
                    <button @click="fetchLogs(-1)" :disabled="currentPage === totalPages" class="button button-primary">&gt;|</button>
                </div>
            </section>
        </template>

        <!-- Modal Structure -->
        <div x-show="selectedLog !== null" x-transition class="modal" @click.self="closeModal()" @popstate.window="closeModal()">
            <div class="modal-content">
                <template x-if="loadingDetail">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                    </div>
                </template>
                <template x-if="!loadingDetail">
                    <div class="log-container">
                        <template x-if="selectedLog">
                            <div>
                                <span x-text="selectedLog?.response_status" class="status" :class="'status-'+String(selectedLog?.response_status)[0]+'xx'"></span>
                                <span x-text="selectedLog.target_url"></span>
                                <p />
                            </div>
                        </template>

                        <div class="log-content">
                            <div class="log-section">
                                <div>Request Headers</div>
                                <template x-if="selectedLog?.request_headers">
                                    <div>
                                        <button @click="copyToClipboard($event)" class="copy-btn" x-html="svgCopy()"></button>
                                        <pre><code class="language-json" x-text="prettyJSON(selectedLog.request_headers)"></code></pre>
                                    </div>
                                </template>
                            </div>

                            <div class="log-section">
                                <div>Request Body</div>
                                <template x-if="selectedLog?.request_body">
                                    <div>
                                        <button @click="copyToClipboard($event)" class="copy-btn" x-html="svgCopy()"></button>
                                        <pre><code class="language-json" x-text="prettyJSON(selectedLog.request_body)"></code></pre>
                                    </div>
                                </template>
                            </div>

                            <div class="log-section">
                                <div>Response Headers</div>
                                <template x-if="selectedLog?.response_headers">
                                    <div>
                                        <button @click="copyToClipboard($event)" class="copy-btn" x-html="svgCopy()"></button>
                                        <pre><code class="language-json" x-text="prettyJSON(selectedLog.response_headers)"></code></pre>
                                    </div>
                                </template>
                            </div>

                            <div class="log-section">
                                <div>Response Body</div>
                                <template x-if="selectedLog?.response_body">
                                    <div>
                                        <button @click="copyToClipboard($event)" class="copy-btn" x-html="svgCopy()"></button>
                                        <pre><code class="language-json" x-text="parseStream(selectedLog.response_body)"></code></pre>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function svgCopy() {
            return "<svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'>"
                + "<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z' />"
                + "</svg>"
        }

        function copyToClipboard(event) {
            const pre = event.target.closest('div').querySelector('pre code')
            const textToCopy = pre.textContent || pre.innerText

            navigator.clipboard.writeText(textToCopy).then(() => {
                console.log('Copied to clipboard')
            }).catch(err => {
                console.error('Error copying text: ', err)
            })
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp)
            const now = new Date()
            const diffMs = now - date
            const diffMins = Math.floor(diffMs / 60000)

            // Check if same day
            if (date.toDateString() === now.toDateString()) {
                if (diffMins < 60) {
                    return `${diffMins}m ago`
                }
                const diffHours = Math.floor(diffMins / 60)
                return `${diffHours}h ago`
            }

            return timestamp
        }

        function prettyJSON(str) {
            try {
                const obj = JSON.parse(str)
                return JSON.stringify(obj, null, 2)
            } catch (e) {
                return str
            }
        }

        function parseStream(streamText) {
            if (!streamText.includes('"choices"') || !streamText.includes('"delta"')) {
                return prettyJSON(streamText);
            }

            // Split the input into individual JSON chunks
            const chunks = streamText.trim().split(/}\s*{/).map((chunk, index) => {
                // Add back the curly braces that were split
                return (index === 0 ? '' : '{') + chunk + (index === streamText.trim().split(/}\s*{/).length - 1 ? '' : '}')
            })

            let assembledContent = ''
            let usageStats = null
            const metadata = {
                id: null,
                model: null,
                system_fingerprint: null,
                created: null
            }

            chunks.forEach(chunk => {
                try {
                    const parsed = JSON.parse(chunk)

                    // Store metadata from first chunk
                    if (!metadata.id) {
                        metadata.id = parsed.id
                        metadata.model = parsed.model
                        metadata.system_fingerprint = parsed.system_fingerprint
                        metadata.created = parsed.created
                    }

                    // Handle content chunks
                    if (parsed.choices && parsed.choices.length > 0 &&
                        parsed.choices[0].delta &&
                        parsed.choices[0].delta.content !== undefined) {
                        assembledContent += parsed.choices[0].delta.content
                    }

                    // Capture usage statistics from final chunk
                    if (parsed.usage) {
                        usageStats = parsed.usage
                    }

                } catch (error) {
                    console.error('Error parsing chunk:', error)
                }
            })

            let obj = {
                metadata,
                content: assembledContent,
                usage: usageStats,
                totalChunks: chunks.length
            }

            return JSON.stringify(obj, null, 2)
        }

        function logData() {
            return {
                logs: [],
                currentPage: 1,
                totalPages: 1,
                loading: true,
                loadingDetail: false,
                sseRetries: 0,
                selectedLog: null,
                clientID: "",
                fetchLogs(page) {
                    this.loading = true
                    fetch('/log?page=' + page)
                        .then(response => response.json())
                        .then(data => {
                            this.logs = data.logs || []
                            this.currentPage = data.currentPage
                            this.totalPages = data.totalPages || 1
                            this.loading = false
                        })
                        .catch(error => {
                            console.error('Error fetching logs:', error)
                            this.loading = false
                        })
                },
                fetchLogDetail(id) {
                    this.loadingDetail = true
                    fetch('/log/detail?id=' + id)
                        .then(response => response.json())
                        .then(data => {
                            history.pushState(null, '', location.href)
                            this.selectedLog = data
                            this.loadingDetail = false
                            this.$nextTick(() => Prism.highlightAll())
                        })
                        .catch(error => {
                            console.error('Error fetching log detail:', error)
                            this.loadingDetail = false
                        })
                },
                initSSE() {
                    const eventSource = new EventSource("/ui/sse");

                    eventSource.onmessage = (event) => {
                        this.sseRetries = 0
                        const data = JSON.parse(event.data)
                        switch (data?.eventType) {
                            case "init":
                                this.clientID = data.clientID
                                break

                            case "insert":
                                data.entry._flash = true
                                this.logs.unshift(data.entry)
                                break

                            case "update":
                                for (let i = 0; i < this.logs.length; i++) {
                                    const log = this.logs[i]
                                    if (log.id == data.entry.id) {
                                        data.entry._flash = true
                                        this.logs[i] = data.entry
                                        break
                                    }
                                }
                                break
                        }
                    }

                    eventSource.onerror = (error) => {
                        const delay = Math.pow(2, ++this.sseRetries) * 1000
                        eventSource.close()
                        setTimeout(() => {
                            console.error("SSE Error, retry in", delay, "seconds")
                            this.initSSE()
                        }, delay)
                    }
                },
                closeModal() {
                    this.selectedLog = null
                },
                addMarker() {
                    this.logs.unshift({ id: '', _marker: true })
                },
                init() {
                    // Close modal on ESC key press
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.selectedLog !== null) {
                            e.preventDefault()
                            this.closeModal()
                        }
                    })

                    // Add marker on SPACE key press
                    document.addEventListener('keydown', (e) => {
                        if (e.key === ' ' && this.selectedLog == null) {
                            e.preventDefault()
                            this.addMarker()
                        }
                    })

                    this.initSSE()
                    this.fetchLogs(this.currentPage)
                }
            }
        }
    </script>
</body>

</html>