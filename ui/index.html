<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMSee</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.global.prod.min.js" integrity="sha512-66fV4MXSQdGN0KQxZ0Bw627HalhTQYQbOoF24EtMXN2FaAoKMgAZ7nDi77d9xWwrRjEEUfE+7rxjTt+cA2IuJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100%;
            width: 100%;
            padding: 0 15px;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            height: 90%;
            max-width: 90%;
            max-height: 90%;
            border-radius: 5px;
            overflow-y: auto;
        }

        .modal-content pre,
        .modal-content pre code {
            max-height: 300px;
            white-space: pre-wrap !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 100% !important;
        }

        .modal-content code {
            font-size: .8em !important;
            border: none !important;
        }

        .modal-content code[class*=language-] {
            padding: 0;
        }

        .modal-content div {
            position: relative;
        }

        .modal-content button.copy-btn {
            position: absolute;
            top: -35px;
            right: 0px;
            width: 30px;
            height: 30px;
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #ffffff;
        }

        .modal-content button.copy-btn:hover {
            border-color: #33C3F0;
            background-color: #33C3F0;
        }

        .modal-content .log-container {
            display: block;
        }

        .modal-content .log-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1px;
        }

        @media (max-width: 768px) {
            .modal-content .log-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .modal-content .log-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        span.status {
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }

        span.status-2xx {
            background-color: #28a745;
        }

        span.status-4xx {
            background-color: #fd7e14;
        }

        span.status-5xx {
            background-color: #dc3545;
        }

        #table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            margin-top: 5px;
        }

        #table-container table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
        }

        #table-container thead th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 30;
            background-color: #33C3F0;
            color: white;
        }

        #table-container th,
        #table-container td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        #table-container th {
            background: #f8f8f8;
            text-align: left;
        }

        #table-container tr.rec {
            cursor: pointer;
            line-height: 0.75;
        }

        #table-container tr.rec:hover {
            background-color: #f0f0f0;
        }

        #table-container tr.rec td {
            font-size: .8em;
            white-space: nowrap;
        }

        #table-container tr.rec td.useragent-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            direction: ltr;
            text-align: left;
        }

        @keyframes fadeOut {
            from {
                background-color: yellow;
            }

            to {
                background-color: white;
            }
        }

        #table-container tr.rec.flash td {
            animation-name: fadeOut;
            animation-duration: 2s;
        }

        #table-container tr.marker {
            cursor: default;
        }

        #table-container tr.marker td {
            border-bottom: 2px solid red;
            padding: 0px;
        }

        #controls {
            display: flex;
            justify-content: flex-start;
            align-items: left;
            gap: 5px;
            margin-top: 5px;
        }

        #controls input {
            margin-bottom: 1rem;
            width: 80px;
            text-align: center;
        }

        #controls button {
            padding-left: 15px;
            padding-right: 15px;
        }

        #controls button:disabled,
        #controls button:disabled:hover {
            cursor: default;
            background-color: #c0c0c0;
            border-color: #c0c0c0;
        }

        #table-container th.center,
        .center {
            text-align: center
        }

        #table-container th.right,
        .right {
            text-align: right
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <section v-if="!loading">
                <div id="controls">
                    <button @click="fetchLogs(1)" :disabled="currentPage === 1" class="button button-primary">|&lt;</button>
                    <button @click="fetchLogs(Math.max(currentPage - 1, 1))" :disabled="currentPage === 1" class="button button-primary">&lt;</button>
                    <input type="number" @change="e => fetchLogs(parseInt(e.target.value))" :value="currentPage">
                    <button @click="fetchLogs(Math.min(currentPage + 1, totalPages))" :disabled="currentPage === totalPages" class="button button-primary">&gt;</button>
                    <button @click="fetchLogs(-1)" :disabled="currentPage === totalPages" class="button button-primary">&gt;|</button>
                    <button @click="addMarker()" class="button button-primary">Marker</button>
                </div>

                <div id="table-container">
                    <table class="u-full-width">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>User Agent</th>
                                <th>Provider</th>
                                <th>Model</th>
                                <th class="center">Status</th>
                                <th class="right">Sent</th>
                                <th class="right">Recv</th>
                                <th class="right">Duration</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="(log, index) in logs" :key="log.id||index">
                                <tr v-if="log._marker" class="marker">
                                    <td colspan="10"></td>
                                </tr>
                                <tr v-else @click="fetchLogDetail(log.id)" :class="['rec', { flash: log._flash }]">
                                    <td>{{ log.id }}</td>
                                    <td :title="log.timestamp">{{ formatTimestamp(log.timestamp) }}</td>
                                    <td class="useragent-cell" :title="log.useragent">{{ log.useragent }}</td>
                                    <td>{{ log.provider }}</td>
                                    <td>{{ log.model }}</td>
                                    <td class="center">
                                        <span class="status" :class="'status-' + String(log.response_status)[0] + 'xx'">
                                            {{ log.response_status }}
                                        </span>
                                    </td>
                                    <td class="right">{{ log.request_body_size ? (log.request_body_size/1024).toFixed(2) + ' KB' : '-' }}</td>
                                    <td class="right">{{ log.response_body_size ? (log.response_body_size/1024).toFixed(2) + ' KB' : '-' }}</td>
                                    <td class="right">{{ log.duration_ms >= 0 ? log.duration_ms + ' ms' : '...' }}</td>
                                    <td>{{ log.method }}</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Modal -->
            <div v-if="selectedLog" class="modal" @click.self="closeModal">
                <div class="modal-content">
                    <div v-if="loadingDetail" class="loading-container">
                        <div class="loading-spinner"></div>
                    </div>
                    <div v-else class="log-container">
                        <div v-if="selectedLog">
                            <span :class="['status', 'status-' + String(selectedLog.response_status)[0] + 'xx']">
                                {{ selectedLog.response_status }}
                            </span>
                            <span>{{ selectedLog.target_url }}</span>
                            <p></p>
                        </div>

                        <div class="log-content">
                            <div class="log-section">
                                <div>Request Headers</div>
                                <div v-if="selectedLog.request_headers">
                                    <button @click="copyToClipboard" class="copy-btn" v-html="svgCopy"></button>
                                    <pre><code class="language-json">{{ prettyJSON(selectedLog.request_headers) }}</code></pre>
                                </div>
                            </div>

                            <div class="log-section">
                                <div>Request Body</div>
                                <div v-if="selectedLog.request_body">
                                    <button @click="copyToClipboard" class="copy-btn" v-html="svgCopy"></button>
                                    <pre><code class="language-json">{{ prettyJSON(selectedLog.request_body) }}</code></pre>
                                </div>
                            </div>

                            <div class="log-section">
                                <div>Response Headers</div>
                                <div v-if="selectedLog.response_headers">
                                    <button @click="copyToClipboard" class="copy-btn" v-html="svgCopy"></button>
                                    <pre><code class="language-json">{{ prettyJSON(selectedLog.response_headers) }}</code></pre>
                                </div>
                            </div>

                            <div class="log-section">
                                <div>Response Body</div>
                                <div v-if="selectedLog.response_body">
                                    <button @click="copyToClipboard" class="copy-btn" v-html="svgCopy"></button>
                                    <pre><code class="language-json">{{ prettyJSON(selectedLog.response_body) }}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    logs: [],
                    currentPage: 1,
                    totalPages: 1,
                    loading: true,
                    loadingDetail: false,
                    sseRetries: 0,
                    selectedLog: null,
                    eventSource: null,
                    clientID: "",
                    svgCopy: "<svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'>"
                        + "<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z' />"
                        + "</svg>"
                }
            },
            methods: {
                async fetchLogs(page) {
                    this.loading = true
                    try {
                        const response = await fetch('/log?page=' + page)
                        const data = await response.json()
                        this.logs = data.logs || []
                        this.currentPage = data.currentPage
                        this.totalPages = data.totalPages || 1
                    } catch (error) {
                        console.error('Error fetching logs:', error)
                    } finally {
                        this.loading = false
                    }
                },
                async fetchLogDetail(id) {
                    this.loadingDetail = true
                    try {
                        const response = await fetch('/log/detail?id=' + id)
                        const data = await response.json()
                        history.pushState({ logId: id }, '', `#${id}`)
                        this.selectedLog = data
                        this.$nextTick(() => Prism.highlightAll())
                    } catch (error) {
                        console.error('Error fetching log detail:', error)
                    } finally {
                        this.loadingDetail = false
                    }
                },
                initSSE() {
                    eventSource = new EventSource("/ui/sse")

                    eventSource.onmessage = (event) => {
                        this.sseRetries = 0
                        const data = JSON.parse(event.data)
                        switch (data?.eventType) {
                            case "init":
                                this.clientID = data.clientID
                                break

                            case "insert":
                                data.entry._flash = true
                                this.logs.unshift(data.entry)
                                break

                            case "update":
                                const index = this.logs.findIndex(log => log.id === data.entry.id)
                                if (index !== -1) {
                                    data.entry._flash = true
                                    this.logs[index] = data.entry
                                }
                                break
                        }
                    }

                    eventSource.onerror = (error) => {
                        const delay = Math.pow(2, ++this.sseRetries) * 1000
                        eventSource.close()
                        setTimeout(() => {
                            console.error("SSE Error, retry in", delay, "seconds")
                            this.initSSE()
                        }, delay)
                    }
                },
                closeModal() {
                    this.selectedLog = null
                    if (history.state && history.state.logId) {
                        history.back()
                    }
                },
                addMarker() {
                    this.logs.unshift({ id: '', _marker: true })
                },
                formatTimestamp(timestamp) {
                    const date = new Date(timestamp)
                    const now = new Date()
                    const diffMs = now - date
                    const diffMins = Math.floor(diffMs / 60000)

                    // Check if same day
                    if (date.toDateString() === now.toDateString()) {
                        if (diffMins < 60) {
                            return `${diffMins}m ago`
                        }
                        const diffHours = Math.floor(diffMins / 60)
                        return `${diffHours}h ago`
                    }

                    return timestamp
                },
                prettyJSON(str) {
                    try {
                        const obj = JSON.parse(str)
                        return JSON.stringify(obj, null, 2)
                    } catch (e) {
                        return str
                    }
                },
                copyToClipboard(event) {
                    const pre = event.target.closest('div').querySelector('pre code')
                    const textToCopy = pre.textContent || pre.innerText

                    navigator.clipboard.writeText(textToCopy)
                        .then(() => console.log('Copied to clipboard'))
                        .catch(err => console.error('Error copying text: ', err))
                }
            },
            mounted() {
                // Close modal on ESC key press
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.selectedLog !== null) {
                        e.preventDefault()
                        this.closeModal()
                    }
                })

                // Add marker on SPACE key press
                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ' && this.selectedLog == null) {
                        e.preventDefault()
                        this.addMarker()
                    }
                })

                window.addEventListener('popstate', (event) => {
                    if (!event.state || !event.state.logId) {
                        this.closeModal()
                    }
                })

                this.initSSE()
                this.fetchLogs(this.currentPage)
            },
            beforeUnmount() {
                document.removeEventListener('keydown', this.escKeyListener)
                document.removeEventListener('keydown', this.spaceKeyListener)
                window.removeEventListener('popstate', this.popStateListener)

                if (this.eventSource) {
                    this.eventSource.close()
                    this.eventSource = null
                }
            }
        }).mount('#app')
    </script>
</body>

</html>